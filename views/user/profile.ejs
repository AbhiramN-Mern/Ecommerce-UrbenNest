<%- include("../../views/partials/user/header") %>

<style>
  /* Core variables */
  :root {
    --primary-color: #3498db;
    --secondary-color: #2c3e50;
    --success-color: #2ecc71;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --light-color: #ecf0f1;
    --dark-color: #34495e;
    --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --border-radius: 8px;
    --transition: all 0.3s ease;
  }

  /* Global styles */
  body {
    font-family: 'Inter', 'Segoe UI', sans-serif;
    background-color: #f8fafc;
    color: #333;
  }

  .main {
    padding: 30px 0;
  }

  /* Breadcrumb */
  .breadcrumb-wrap {
    background-color: white;
    padding: 15px 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    margin-bottom: 25px;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    font-size: 14px;
    color: #666;
  }

  .breadcrumb a {
    color: var(--primary-color);
    text-decoration: none;
    position: relative;
    margin: 0 5px;
    transition: var(--transition);
  }

  .breadcrumb a:hover {
    color: var(--secondary-color);
  }

  .breadcrumb span {
    margin: 0 5px;
    color: #999;
  }

  /* Dashboard menu */
  .dashboard-menu {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    height: 100%;
  }

  .dashboard-menu .nav-link {
    padding: 15px 20px;
    color: var(--secondary-color);
    border-left: 3px solid transparent;
    transition: var(--transition);
    font-weight: 500;
    display: flex;
    align-items: center;
    margin: 5px 0;
  }

  .dashboard-menu .nav-link i {
    margin-right: 10px;
    font-size: 18px;
  }

  .dashboard-menu .nav-link:hover {
    background-color: rgba(52, 152, 219, 0.1);
    color: var(--primary-color);
    border-left: 3px solid var(--primary-color);
  }

  .dashboard-menu .nav-link.active {
    background-color: rgba(52, 152, 219, 0.15);
    color: var(--primary-color);
    border-left: 3px solid var(--primary-color);
    font-weight: 600;
  }

  /* Content cards */
  .card {
    border: none;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-bottom: 25px;
    overflow: hidden;
    transition: var(--transition);
  }

  .card:hover {
    box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
  }

  .card-header {
    padding: 15px 20px;
    font-weight: 600;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .card-body {
    padding: 20px;
  }

  /* Card header colors */
  .card-header-primary {
    background-color: var(--primary-color);
    color: white;
  }

  .card-header-success {
    background-color: var(--success-color);
    color: white;
  }

  .card-header-warning {
    background-color: var(--warning-color);
    color: white;
  }

  /* Buttons */
  .btn {
    border-radius: var(--border-radius);
    padding: 8px 16px;
    font-weight: 500;
    transition: var(--transition);
  }

  .btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
  }

  .btn-primary:hover {
    background-color: #2980b9;
    border-color: #2980b9;
  }

  .btn-success {
    background-color: var(--success-color);
    border-color: var(--success-color);
  }

  .btn-success:hover {
    background-color: #27ae60;
    border-color: #27ae60;
  }

  .btn-outline-primary {
    color: var(--primary-color);
    border-color: var(--primary-color);
  }

  .btn-outline-primary:hover {
    background-color: var(--primary-color);
    color: white;
  }

  .btn-outline-danger {
    color: var(--danger-color);
    border-color: var(--danger-color);
  }

  .btn-outline-danger:hover {
    background-color: var(--danger-color);
    color: white;
  }

  /* Address cards */
  .address-card {
    height: 100%;
    transition: var(--transition);
  }

  .address-card:hover {
    transform: translateY(-5px);
  }

  /* Tables */
  .table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
  }

  .table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: var(--secondary-color);
  }

  .table th,
  .table td {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
  }

  .table tr:last-child td {
    border-bottom: none;
  }

  .table tr:hover {
    background-color: #f8f9fa;
  }

  /* Profile section */
  .profile-section {
    padding: 25px;
  }

  .profile-info {
    margin-bottom: 5px;
    display: flex;
    align-items: center;
  }

  .profile-info i {
    width: 24px;
    color: var(--primary-color);
    margin-right: 10px;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .dashboard-container {
      flex-direction: column;
    }
    
    .dashboard-menu {
      margin-bottom: 20px;
    }
    
    .dashboard-menu .nav {
      display: flex;
      flex-wrap: wrap;
    }
    
    .dashboard-menu .nav-item {
      width: 50%;
    }
  }

  /* Custom style for Add Money Box */
  .add-money-box {
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 10px;
    transition: box-shadow 0.3s ease;
  }

  .add-money-box:hover {
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
  }

  .add-money-box h5 {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--primary-color);
  }

  #addMoneyForm .form-control {
    border-radius: 8px;
    padding: 10px;
    font-size: 1rem;
    border: 1px solid #ccc;
    transition: border-color 0.3s ease;
  }

  #addMoneyForm .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
  }

  #addMoneyForm button {
    border-radius: 8px;
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: 600;
    transition: background-color 0.3s ease;
  }

  #addMoneyForm button:hover {
    background-color: #2980b9;
    border-color: #2980b9;
  }

  /* Responsive adjustments */
  @media (max-width: 576px) {
    .add-money-box {
      padding: 2rem 1rem;
    }

    #addMoneyForm .form-control {
      width: 100%;
    }

    #addMoneyForm button {
      width: 100%;
    }
  }

  /* Add to your existing styles in profile.ejs */
  .pagination {
    margin-bottom: 0;
  }

  .page-link {
    color: var(--primary-color);
    border-color: var(--primary-color);
  }

  .page-item.active .page-link {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
  }

  .page-item.disabled .page-link {
    color: #6c757d;
    border-color: #dee2e6;
  }
</style>

<main class="main">
  <div class="page-header breadcrumb-wrap">
    <div class="container">
      <div class="breadcrumb">
        <a href="/" rel="nofollow">Home</a>
        <span>/</span> Profile <span>/</span> Account
      </div>
    </div>
  </div>
  
  <section class="pt-3 pb-5">
    <div class="container">
      <div class="row dashboard-container g-4">
        <!-- Left sidebar -->
        <div class="col-lg-3">
          <div class="dashboard-menu">
            <ul class="nav flex-column" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab">
                  <i class="fas fa-th-large"></i> Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab">
                  <i class="fas fa-map-marker-alt"></i> My Addresses
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab">
                  <i class="fas fa-shopping-bag"></i> Orders
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="wallet-tab" data-bs-toggle="tab" href="#wallet" role="tab">
                  <i class="fas fa-wallet"></i> Wallet
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="referral-tab" data-bs-toggle="tab" href="#referal" role="tab">
                  <i class="fas fa-user-friends"></i> Referrals
                </a>
              </li>
              <li class="nav-item mt-3">
                <a class="nav-link text-danger" href="/logout">
                  <i class="fas fa-sign-out-alt"></i> Logout
                </a>
              </li>
            </ul>
          </div>
        </div>
        
        <!-- Right content -->
        <div class="col-lg-9">
          <div class="tab-content dashboard-content">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
              <div class="card">
                <div class="card-header card-header-primary">
                  <h5 class="mb-0">User Profile</h5>
                </div>
                <div class="card-body profile-section">
                  <div class="text-center mb-4">
                    <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center mb-3" style="width: 100px; height: 100px;">
                      <i class="fas fa-user" style="font-size: 40px; color: var(--primary-color);"></i>
                    </div>
                    <h4 class="fw-bold text-primary"><%= user.name %></h4>
                  </div>
                  
                  <div class="row justify-content-center">
                    <div class="col-md-8">
                      <div class="profile-info">
                        <i class="fas fa-phone-alt"></i>
                        <span><strong>Phone:</strong> <%= user.phone %></span>
                      </div>
                      <div class="profile-info">
                        <i class="fas fa-envelope"></i>
                        <span><strong>Email:</strong> <%= user.email %></span>
                      </div>
                      
                      <div class="d-flex justify-content-center gap-2 mt-4">
                        <a href="/change-email" class="btn btn-outline-primary">
                          <i class="fas fa-envelope me-2"></i>Change Email
                        </a>
                        <a href="/change-password" class="btn btn-outline-primary">
                          <i class="fas fa-lock me-2"></i>Change Password
                        </a>
                        <a href="/forgot-password" class="btn btn-outline-primary">
                          <i class="fas fa-lock me-2"></i>Forgot Password
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Address Tab -->
            <div class="tab-pane fade" id="address" role="tabpanel">
              <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Your Addresses</h5>
                  <a href="/addAddress" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus-circle me-1"></i> Add New Address
                  </a>
                </div>
                <div class="card-body">
                  <div class="row">
                    <% if (locals.userAddress && userAddress.address && userAddress.address.length > 0) { %>
                      <% userAddress.address.forEach((address) => { %>
                        <div class="col-md-6 mb-3">
                          <div class="card h-100 address-card position-relative border <%= address.addressType === 'Home' ? 'border-primary' : '' %>">
                            <div class="card-body">
                              <div class="mb-2">
                                <span class="badge bg-primary">
                                  <%= address.addressType %> Address
                                </span>
                              </div>
                              <div class="address-details">
                                <p class="mb-1 fw-bold"><%= address.name %></p>
                                <p class="mb-1">
                                  <%= address.city %>, <%= address.landMark %><br>
                                  <%= address.state %> - <%= address.pinCode %>
                                </p>
                                <p class="mb-1">
                                  <i class="fas fa-phone text-primary me-2"></i><%= address.phone %><br>
                                  <% if (address.altPhone) { %>
                                    <i class="fas fa-phone-alt text-primary me-2"></i><%= address.altPhone %>
                                  <% } %>
                                </p>
                              </div>
                              <div class="address-actions d-flex mt-3 gap-2">
                                <a href="/editAddress?id=<%= address._id %>" 
                                  class="btn btn-outline-primary btn-sm flex-grow-1">
                                  <i class="fas fa-edit me-1"></i>
                                  Edit
                                </a>
                                <button onclick="confirmDeleteAddress('<%= address._id %>')" 
                                        class="btn btn-outline-danger btn-sm flex-grow-1">
                                  <i class="fas fa-trash-alt me-1"></i>
                                  Delete
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      <% }) %>
                    <% } else { %>
                      <div class="col-12">
                        <div class="text-center py-4">
                          <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                          <p class="mb-3">No saved addresses found. Please add a delivery address.</p>
                          <a href="/addAddress" class="btn btn-primary">
                            <i class="fas fa-plus-circle me-2"></i>Add New Address
                          </a>
                        </div>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>

            <!-- Orders Tab -->
            <div class="tab-pane fade" id="orders" role="tabpanel">
              <div class="card">
                <div class="card-header card-header-primary">
                  <h5 class="mb-0">Your Orders</h5>
                </div>
                <div class="card-body">
                  <% if (orders && orders.length > 0) { %>
                    <div class="table-responsive">
                      <table class="table">
                        <thead>
                          <tr>
                            <th>Order ID</th>
                            <th>Status</th>
                            <th>Total</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% orders.forEach(order => { %>
                            <tr>
                              <td><span class="text-primary">#<%= order.orderId || order._id %></span></td>
                              <td>
                                <span class="badge bg-<%= 
                                  order.status === 'Delivered' ? 'success' : 
                                  order.status === 'Processing' ? 'primary' : 
                                  order.status === 'Shipped' ? 'info' : 
                                  order.status === 'Payment Pending' ? 'warning' :
                                  order.status === 'Cancelled' ? 'danger' : 'secondary' 
                                %>">
                                  <%= order.status %>
                                </span>
                                <% if (order.status === 'Payment Pending') { %>
                                  <button 
                                    onclick="retryPayment('<%= order._id %>', <%= order.finalAmount %>)" 
                                    class="btn btn-warning btn-sm ms-2">
                                    <i class="fas fa-redo-alt"></i> Retry Payment
                                  </button>
                                <% } %>
                              </td>
                              <td>₹<%= order.finalAmount.toLocaleString() %></td>
                              <td>
                                <a href="/orderDetails?id=<%= order._id %>" class="btn btn-sm btn-outline-primary">
                                  <i class="fas fa-eye me-1"></i>View
                                </a>
                              </td>
                            </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  <% } else { %>
                    <div class="text-center py-4">
                      <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                      <p class="mb-0">No orders found.</p>
                      <a href="/shop" class="btn btn-primary mt-3">
                        <i class="fas fa-shopping-cart me-2"></i>Start Shopping
                      </a>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
            
            <!-- Wallet Tab -->
            <div class="tab-pane fade" id="wallet" role="tabpanel">
              <div class="card">
                <div class="card-header card-header-primary">
                  <h5 class="mb-0">Wallet</h5>
                </div>
                <div class="card-body">
                  <!-- Improved Add Money Section in Wallet Tab -->
                  <div class="row align-items-center mb-4">
                    <div class="col-md-6">
                      <div class="text-center py-3">
                        <h5 class="mt-3">Current Balance</h5>
                        <h2 class="text-primary fw-bold" id="wallet-balance">₹<%= (walletBalance || 0).toFixed(2) %></h2>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="add-money-box p-4 border rounded shadow-sm bg-light">
                        <h5 class="text-center mb-3">Add Money to Wallet</h5>
                        <form id="addMoneyForm" class="d-flex flex-column align-items-center">
                          <input type="number" name="amount" placeholder="Enter amount" required class="form-control mb-3 text-center" style="max-width: 200px;" />
                          <button type="submit" class="btn btn-primary w-100">Add Money</button>
                        </form>
                      </div>
                    </div>
                  </div>
                  
                  <h5 class="mb-3">Transaction History</h5>
                  <div class="table-responsive">
                    <table class="table" id="wallet-history-table">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Transaction</th>
                          <th>Status</th>
                          <th>Amount</th>
                          <th>Description</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if (walletHistory && walletHistory.length > 0) { %>
                          <% walletHistory.forEach(txn => { %>
                            <tr>
                              <td><%= new Date(txn.date).toLocaleDateString() %></td>
                              <td><%= txn.type %></td>
                              <td><%= txn.status %></td>
                              <td>₹<%= txn.amount %></td>
                              <td><%= txn.description %></td>
                            </tr>
                          <% }) %>
                        <% } else { %>
                          <tr>
                            <td colspan="5" class="text-center py-4">
                              <i class="fas fa-history fa-3x text-muted mb-3"></i>
                              <p class="mb-0">No transactions yet</p>
                            </td>
                          </tr>
                        <% } %>
                      </tbody>
                    </table>

                    <!-- Add Pagination Controls -->
                    <% if (pagination.totalPages > 1) { %>
                      <nav aria-label="Wallet history pagination" class="d-flex justify-content-center mt-4">
                        <ul class="pagination">
                          <!-- Previous Page -->
                          <li class="page-item <%= !pagination.hasPrevPage ? 'disabled' : '' %>">
                            <a class="page-link" href="?page=<%= pagination.prevPage %>" <%= !pagination.hasPrevPage ? 'tabindex="-1" aria-disabled="true"' : '' %>>
                              Previous
                            </a>
                          </li>

                          <!-- Page Numbers -->
                          <% for(let i = 1; i <= pagination.totalPages; i++) { %>
                            <li class="page-item <%= pagination.page === i ? 'active' : '' %>">
                              <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                            </li>
                          <% } %>

                          <!-- Next Page -->
                          <li class="page-item <%= !pagination.hasNextPage ? 'disabled' : '' %>">
                            <a class="page-link" href="?page=<%= pagination.nextPage %>" <%= !pagination.hasNextPage ? 'tabindex="-1" aria-disabled="true"' : '' %>>
                              Next
                            </a>
                          </li>
                        </ul>
                      </nav>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Referrals Tab -->
            <div class="tab-pane fade" id="referal" role="tabpanel">
              <div class="card">
                <div class="card-header card-header-primary">
                  <h5 class="mb-0">Referral Program</h5>
                </div>
                <div class="card-body">
                  <div class="text-center py-3">
                    <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center mb-3" 
                         style="width: 80px; height: 80px;">
                      <i class="fas fa-user-friends fa-2x text-primary"></i>
                    </div>
                    <h5 class="mb-4">Invite Friends & Earn Rewards!</h5>
                  </div>
                  
                  <div class="mb-4">
                    <label class="form-label fw-bold">Your Referral Link</label>
                    <div class="input-group">
                      <!-- Build the referral URL using the referralCode -->
                      <input type="text" class="form-control" value="<%= referralCode %>" readonly>
                      <button class="btn btn-outline-primary" type="button" id="copyBtn">
                        <i class="fas fa-copy"></i> Copy
                      </button>
                    </div>
                  </div>
                  
                  <div class="row g-4">
                    <div class="col-md-6">
                      <div class="card h-100">
                        <div class="card-body text-center">
                          <i class="fas fa-gift fa-2x text-primary mb-3"></i>
                          <h5>Your Earnings</h5>
                          <!-- Wallet bonus earnings -->
                          <h3 class="text-primary mt-2">₹<%= (referralEarnings || 0).toFixed(2) %></h3>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card h-100">
                        <div class="card-body text-center">
                          <i class="fas fa-users fa-2x text-primary mb-3"></i>
                          <h5>Successful Referrals</h5>
                          <!-- Show the dynamic count of referrals -->
                          <h3 class="text-primary mt-2"><%= successfulReferrals %></h3>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- New section: Referral History -->
                  <div class="mt-4">
                    <h5 class="text-center">Referral History</h5>
                    <% 
                      // Filter referral transactions from walletHistory using description
                      let referralHistory = walletHistory.filter(txn => txn.description && txn.description.startsWith("Referral reward")); 
                    %>
                    <% if (referralHistory.length > 0) { %>
                      <div class="table-responsive">
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>Date</th>
                              <th>Amount</th>
                              <th>Description</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% referralHistory.forEach(txn => { %>
                              <tr>
                                <td><%= new Date(txn.date).toLocaleDateString() %></td>
                                <td>₹<%= txn.amount %></td>
                                <td><%= txn.description %></td>
                              </tr>
                            <% }) %>
                          </tbody>
                        </table>
                      </div>
                    <% } else { %>
                      <p class="text-center text-muted">No referrals yet.</p>
                    <% } %>
                  </div>
                  
                  <div class="text-center mt-4">
                    <button class="btn btn-primary">
                      <i class="fas fa-share-alt me-2"></i>Share Now
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Success Toast -->
<div class="toast-container position-fixed top-0 end-0 p-3">
  <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Money added to your wallet successfully!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Place this in the <head> or just before your custom wallet script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  // Copy referral link functionality
  document.getElementById('copyBtn')?.addEventListener('click', function() {
    const copyText = this.previousElementSibling;
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value);
    this.innerHTML = '<i class="fas fa-check"></i> Copied!';
    setTimeout(() => {
      this.innerHTML = '<i class="fas fa-copy"></i> Copy';
    }, 2000);
  });

  document.getElementById('addMoneyForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const amount = this.amount.value;
    fetch('/wallet/addMoney', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount: amount })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          var options = {
            key: "<%= process.env.RAZORPAY_KEY_ID %>",
            amount: amount * 100,
            currency: "INR",
            name: "UrbanNest",
            description: "Add Money to Wallet",
            order_id: data.order.id,
            handler: function (response) {
              // Call our backend to update the wallet balance
              fetch('/wallet/paymentSuccess', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  razorpayPaymentId: response.razorpay_payment_id,
                  razorpayOrderId: response.razorpay_order_id,
                  razorpaySignature: response.razorpay_signature,
                  amount: amount
                })
              })
                .then(res => res.json())
                .then(result => {
                  if (result.success) {
                    // Show success toast
                    const toast = new bootstrap.Toast(document.getElementById('successToast'));
                    toast.show();
                    // Reload the page after a short delay
                    setTimeout(() => location.reload(), 2000);
                  } else {
                    alert("Payment succeeded, but wallet update failed.");
                  }
                });
            },
            prefill: {
              name: "<%= user.name %>",
              email: "<%= user.email %>"
            },
            theme: {
              color: "#3498db"
            }
          };
          var rzp1 = new Razorpay(options);
          rzp1.open();
        } else {
          alert("Error initiating payment. Please try again.");
        }
      })
      .catch(err => console.error(err));
  });

  function confirmDeleteAddress(addressId) {
    Swal.fire({
      title: 'Delete Address?',
      text: 'Are you sure you want to delete this address?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = `/deleteAddress?id=${addressId}`;
      }
    });
  }

  async function retryPayment(orderId, amount) {
    try {
      // Create new Razorpay order
      const response = await fetch('/create-razorpay-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount })
      });
      
      const result = await response.json();
      if (!result.success) throw new Error(result.message);

      const options = {
        key: "<%= process.env.RAZORPAY_KEY_ID %>",
        amount: result.order.amount,
        currency: "INR",
        name: "UrbenNest",
        description: "Complete Pending Order Payment",
        order_id: result.order.id,
        handler: async function (response) {
          try {
            // Verify payment and update order status
            const verifyResponse = await fetch('/complete-payment', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                orderId: orderId,
                razorpayPaymentId: response.razorpay_payment_id,
                razorpayOrderId: response.razorpay_order_id,
                razorpaySignature: response.razorpay_signature
              })
            });

            const data = await verifyResponse.json();
            if (data.success) {
              Swal.fire({
                icon: 'success',
                title: 'Payment Successful',
                text: 'Your order has been confirmed!',
                showConfirmButton: false,
                timer: 2000
              }).then(() => {
                window.location.reload();
              });
            } else {
              throw new Error(data.message || 'Payment verification failed');
            }
          } catch (error) {
            Swal.fire({
              icon: 'error',
              title: 'Payment Failed',
              text: error.message || 'Something went wrong',
            });
          }
        },
        prefill: {
          name: "<%= user.name %>",
          email: "<%= user.email %>",
          contact: "<%= user.phone %>"
        },
        theme: {
          color: "#3399cc"
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();

    } catch (error) {
      console.error('Error:', error);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: error.message || 'Failed to initialize payment'
      });
    }
  }
</script>

<%- include("../../views/partials/user/footer") %>