<%- include("../../views/partials/user/header") %>

<style>
  /* Core variables */
  :root {
    --primary-color: #3498db;
    --secondary-color: #2c3e50;
    --success-color: #2ecc71;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --light-color: #ecf0f1;
    --dark-color: #34495e;
    --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --border-radius: 8px;
    --transition: all 0.3s ease;
  }

  /* Global styles */
  body {
    font-family: 'Inter', 'Segoe UI', sans-serif;
    background-color: #f8fafc;
    color: #333;
  }

  .main {
    padding: 30px 0;
  }

  /* Breadcrumb */
  .breadcrumb-wrap {
    background-color: white;
    padding: 15px 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    margin-bottom: 25px;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    font-size: 14px;
    color: #666;
  }

  .breadcrumb a {
    color: var(--primary-color);
    text-decoration: none;
    position: relative;
    margin: 0 5px;
    transition: var(--transition);
  }

  .breadcrumb a:hover {
    color: var(--secondary-color);
  }

  .breadcrumb span {
    margin: 0 5px;
    color: #999;
  }

  /* Dashboard menu */
  .dashboard-menu {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    height: 100%;
  }

  .dashboard-menu .nav-link {
    padding: 15px 20px;
    color: var(--secondary-color);
    border-left: 3px solid transparent;
    transition: var(--transition);
    font-weight: 500;
    display: flex;
    align-items: center;
    margin: 5px 0;
  }

  .dashboard-menu .nav-link i {
    margin-right: 10px;
    font-size: 18px;
  }

  .dashboard-menu .nav-link:hover {
    background-color: rgba(52, 152, 219, 0.1);
    color: var(--primary-color);
    border-left: 3px solid var(--primary-color);
  }

  .dashboard-menu .nav-link.active {
    background-color: rgba(52, 152, 219, 0.15);
    color: var(--primary-color);
    border-left: 3px solid var(--primary-color);
    font-weight: 600;
  }

  /* Content cards */
  .card {
    border: none;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-bottom: 25px;
    overflow: hidden;
    transition: var(--transition);
  }

  .card:hover {
    box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
  }

  .card-header {
    padding: 15px 20px;
    font-weight: 600;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .card-body {
    padding: 20px;
  }

  /* Card header colors */
  .card-header-primary {
    background-color: var(--primary-color);
    color: white;
  }

  .card-header-success {
    background-color: var(--success-color);
    color: white;
  }

  .card-header-warning {
    background-color: var(--warning-color);
    color: white;
  }

  /* Buttons */
  .btn {
    border-radius: var(--border-radius);
    padding: 8px 16px;
    font-weight: 500;
    transition: var(--transition);
  }

  .btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
  }

  .btn-primary:hover {
    background-color: #2980b9;
    border-color: #2980b9;
  }

  .btn-success {
    background-color: var(--success-color);
    border-color: var(--success-color);
  }

  .btn-success:hover {
    background-color: #27ae60;
    border-color: #27ae60;
  }

  .btn-outline-primary {
    color: var(--primary-color);
    border-color: var(--primary-color);
  }

  .btn-outline-primary:hover {
    background-color: var(--primary-color);
    color: white;
  }

  .btn-outline-danger {
    color: var(--danger-color);
    border-color: var(--danger-color);
  }

  .btn-outline-danger:hover {
    background-color: var(--danger-color);
    color: white;
  }

  /* Address cards */
  .address-card {
    height: 100%;
    transition: var(--transition);
  }

  .address-card:hover {
    transform: translateY(-5px);
  }

  /* Tables */
  .table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
  }

  .table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: var(--secondary-color);
  }

  .table th,
  .table td {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
  }

  .table tr:last-child td {
    border-bottom: none;
  }

  .table tr:hover {
    background-color: #f8f9fa;
  }

  /* Profile section */
  .profile-section {
    padding: 25px;
  }

  .profile-info {
    margin-bottom: 5px;
    display: flex;
    align-items: center;
  }

  .profile-info i {
    width: 24px;
    color: var(--primary-color);
    margin-right: 10px;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .dashboard-container {
      flex-direction: column;
    }
    
    .dashboard-menu {
      margin-bottom: 20px;
    }
    
    .dashboard-menu .nav {
      display: flex;
      flex-wrap: wrap;
    }
    
    .dashboard-menu .nav-item {
      width: 50%;
    }
  }
</style>

<main class="main">
  <div class="page-header breadcrumb-wrap">
    <div class="container">
      <div class="breadcrumb">
        <a href="/" rel="nofollow">Home</a>
        <span>/</span> Profile <span>/</span> Account
      </div>
    </div>
  </div>
  
  <section class="pt-3 pb-5">
    <div class="container">
      <div class="row dashboard-container g-4">
        <!-- Left sidebar -->
        <div class="col-lg-3">
          <div class="dashboard-menu">
            <ul class="nav flex-column" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab">
                  <i class="fas fa-th-large"></i> Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab">
                  <i class="fas fa-map-marker-alt"></i> My Addresses
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab">
                  <i class="fas fa-shopping-bag"></i> Orders
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="wallet-tab" data-bs-toggle="tab" href="#wallet" role="tab">
                  <i class="fas fa-wallet"></i> Wallet
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="referral-tab" data-bs-toggle="tab" href="#referal" role="tab">
                  <i class="fas fa-user-friends"></i> Referrals
                </a>
              </li>
              <li class="nav-item mt-3">
                <a class="nav-link text-danger" href="/logout">
                  <i class="fas fa-sign-out-alt"></i> Logout
                </a>
              </li>
            </ul>
          </div>
        </div>
        
        <!-- Right content -->
        <div class="col-lg-9">
          <div class="tab-content dashboard-content">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
              <div class="card">
                <div class="card-header card-header-primary">
                  <h5 class="mb-0">User Profile</h5>
                </div>
                <div class="card-body profile-section">
                  <div class="text-center mb-4">
                    <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center mb-3" style="width: 100px; height: 100px;">
                      <i class="fas fa-user" style="font-size: 40px; color: var(--primary-color);"></i>
                    </div>
                    <h4 class="fw-bold text-primary"><%= user.name %></h4>
                  </div>
                  
                  <div class="row justify-content-center">
                    <div class="col-md-8">
                      <div class="profile-info">
                        <i class="fas fa-phone-alt"></i>
                        <span><strong>Phone:</strong> <%= user.phone %></span>
                      </div>
                      <div class="profile-info">
                        <i class="fas fa-envelope"></i>
                        <span><strong>Email:</strong> <%= user.email %></span>
                      </div>
                      
                      <div class="d-flex justify-content-center gap-2 mt-4">
                        <a href="/change-email" class="btn btn-outline-primary">
                          <i class="fas fa-envelope me-2"></i>Change Email
                        </a>
                        <a href="/change-password" class="btn btn-outline-primary">
                          <i class="fas fa-lock me-2"></i>Change Password
                        </a>
                        <a href="/forgot-password" class="btn btn-outline-primary">
                          <i class="fas fa-lock me-2"></i>Forgot Password
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Address Tab -->
            <div class="tab-pane fade" id="address" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0">Your Addresses</h5>
                <a href="/addAddress" class="btn btn-primary">
                  <i class="fas fa-plus-circle me-2"></i>Add New Address
                </a>
              </div>
              
              <div class="row g-4">
                <% if (userAddress && userAddress.address && userAddress.address.length > 0) { %>
                  <% userAddress.address.forEach((address) => { %>
                    <div class="col-md-6">
                      <div class="card address-card h-100">
                        <div class="card-header card-header-primary d-flex justify-content-between align-items-center">
                          <h5 class="mb-0"><%= address.addressType %> Address</h5>
                          <span class="badge bg-light text-dark"><%= address.name %></span>
                        </div>
                        <div class="card-body">
                          <div class="mb-3">
                            <p class="mb-1"><i class="fas fa-map-marker-alt text-primary me-2"></i><strong>Address:</strong> <%= address.city %></p>
                            <p class="mb-1"><i class="fas fa-landmark text-primary me-2"></i><strong>Landmark:</strong> <%= address.landMark %></p>
                            <p class="mb-1"><i class="fas fa-map text-primary me-2"></i><strong>State:</strong> <%= address.state %></p>
                            <p class="mb-1"><i class="fas fa-map-pin text-primary me-2"></i><strong>Pincode:</strong> <%= address.pinCode %></p>
                            <p class="mb-1"><i class="fas fa-phone text-primary me-2"></i><strong>Phone:</strong> <%= address.phone %></p>
                            <p class="mb-1"><i class="fas fa-phone-alt text-primary me-2"></i><strong>Alt Phone:</strong> <%= address.altPhone %></p>
                          </div>
                          
                          <div class="d-flex justify-content-between mt-3">
                            <a href="/editAddress?id=<%= address._id %>" class="btn btn-sm btn-outline-primary">
                              <i class="fas fa-edit me-1"></i>Edit
                            </a>
                            <a href="/deleteAddress?id=<%= address._id %>" class="btn btn-sm btn-outline-danger" 
                               onclick="return confirm('Are you sure you want to delete this address?')">
                              <i class="fas fa-trash-alt me-1"></i>Delete
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% }) %>
                <% } else { %>
                  <div class="col-12">
                    <div class="card">
                      <div class="card-header card-header-warning">
                        <h5 class="mb-0">No Addresses Found</h5>
                      </div>
                      <div class="card-body text-center py-4">
                        <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                        <p class="mb-3">You haven't added any addresses to your profile yet.</p>
                        <p>Please add an address to continue with your orders.</p>
                        <a href="/addAddress" class="btn btn-primary mt-2">
                          <i class="fas fa-plus-circle me-2"></i>Add New Address
                        </a>
                      </div>
                    </div>
                  </div>
                <% } %>
              </div>
            </div>
            
            <!-- Orders Tab -->
            <div class="tab-pane fade" id="orders" role="tabpanel">
              <div class="card">
                <div class="card-header card-header-primary">
                  <h5 class="mb-0">Your Orders</h5>
                </div>
                <div class="card-body">
                  <% if (orders && orders.length > 0) { %>
                    <div class="table-responsive">
                      <table class="table">
                        <thead>
                          <tr>
                            <th>Order ID</th>
                            <th>Status</th>
                            <th>Total</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% orders.forEach(order => { %>
                            <tr>
                              <td><span class="text-primary">#<%= order.orderId || order._id %></span></td>
                              <td>
                                <span class="badge bg-<%= 
                                  order.status === 'Delivered' ? 'success' : 
                                  order.status === 'Processing' ? 'primary' : 
                                  order.status === 'Shipped' ? 'info' : 
                                  order.status === 'Cancelled' ? 'danger' : 'warning' 
                                %>">
                                  <%= order.status %>
                                </span>
                              </td>
                              <td>₹<%= (order.totalPrice + order.deliveryCharge).toLocaleString() %></td>
                              <td>
                                <a href="/orderDetails?id=<%= order._id %>" class="btn btn-sm btn-outline-primary">
                                  <i class="fas fa-eye me-1"></i>View
                                </a>
                              </td>
                            </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  <% } else { %>
                    <div class="text-center py-4">
                      <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                      <p class="mb-0">No orders found.</p>
                      <a href="/shop" class="btn btn-primary mt-3">
                        <i class="fas fa-shopping-cart me-2"></i>Start Shopping
                      </a>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
            
            <!-- Wallet Tab -->
            <div class="tab-pane fade" id="wallet" role="tabpanel">
              <div class="card">
                <div class="card-header card-header-primary">
                  <h5 class="mb-0">Wallet</h5>
                </div>
                <div class="card-body">
                  <!-- Wallet Balance Section -->
                  <div class="text-center py-3 mb-4">
                    <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center mb-3" 
                         style="width: 100px; height: 100px;">
                      <i class="fas fa-wallet fa-3x text-primary"></i>
                    </div>
                    <h5 class="mt-3">Current Balance</h5>
                    <h2 class="text-primary fw-bold" id="wallet-balance">₹<%= walletBalance.toFixed(2) %></h2>
                  </div>
                  
                  <!-- Transaction History Section -->
                  <h5 class="mb-3">Transaction History</h5>
                  <div class="table-responsive">
                    <table class="table" id="wallet-history-table">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Transaction</th>
                          <th>Status</th>
                          <th>Amount</th>
                          <th>Description</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if (walletHistory.length > 0) { %>
                          <% walletHistory.forEach(txn => { %>
                            <tr>
                              <td><%= new Date(txn.date).toLocaleDateString() %></td>
                              <td><%= txn.status %></td>
                              <td>₹<%= txn.amount %></td>
                              <td><%= txn.description %></td>
                            </tr>
                          <% }) %>
                        <% } else { %>
                          <tr>
                            <td colspan="5" class="text-center py-4">
                              <i class="fas fa-history fa-3x text-muted mb-3"></i>
                              <p class="mb-0">No transactions yet</p>
                            </td>
                          </tr>
                        <% } %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Referrals Tab -->
            <div class="tab-pane fade" id="referal" role="tabpanel">
              <div class="card">
                <div class="card-header card-header-primary">
                  <h5 class="mb-0">Referral Program</h5>
                </div>
                <div class="card-body">
                  <div class="text-center py-3">
                    <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center mb-3" 
                         style="width: 80px; height: 80px;">
                      <i class="fas fa-user-friends fa-2x text-primary"></i>
                    </div>
                    <h5 class="mb-4">Invite Friends & Earn Rewards!</h5>
                  </div>
                  
                  <div class="mb-4">
                    <label class="form-label fw-bold">Your Referral Link</label>
                    <div class="input-group">
                      <!-- Build the referral URL using the referralCode -->
                      <input type="text" class="form-control" value="https://yourdomain.com/signup?ref=<%= referralCode %>" readonly>
                      <button class="btn btn-outline-primary" type="button" id="copyBtn">
                        <i class="fas fa-copy"></i> Copy
                      </button>
                    </div>
                  </div>
                  
                  <div class="row g-4">
                    <div class="col-md-6">
                      <div class="card h-100">
                        <div class="card-body text-center">
                          <i class="fas fa-gift fa-2x text-primary mb-3"></i>
                          <h5>Your Earnings</h5>
                          <!-- Wallet bonus earnings -->
                          <h3 class="text-primary mt-2">₹<%= walletBalance.toFixed(2) %></h3>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card h-100">
                        <div class="card-body text-center">
                          <i class="fas fa-users fa-2x text-primary mb-3"></i>
                          <h5>Successful Referrals</h5>
                          <!-- Show the dynamic count of referrals -->
                          <h3 class="text-primary mt-2"><%= successfulReferrals %></h3>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- New section: Referral History -->
                  <div class="mt-4">
                    <h5 class="text-center">Referral History</h5>
                    <% 
                      // Filter referral transactions from walletHistory using description
                      let referralHistory = walletHistory.filter(txn => txn.description && txn.description.startsWith("Referral reward")); 
                    %>
                    <% if (referralHistory.length > 0) { %>
                      <div class="table-responsive">
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>Date</th>
                              <th>Amount</th>
                              <th>Description</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% referralHistory.forEach(txn => { %>
                              <tr>
                                <td><%= new Date(txn.date).toLocaleDateString() %></td>
                                <td>₹<%= txn.amount %></td>
                                <td><%= txn.description %></td>
                              </tr>
                            <% }) %>
                          </tbody>
                        </table>
                      </div>
                    <% } else { %>
                      <p class="text-center text-muted">No referrals yet.</p>
                    <% } %>
                  </div>
                  
                  <div class="text-center mt-4">
                    <button class="btn btn-primary">
                      <i class="fas fa-share-alt me-2"></i>Share Now
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Copy referral link functionality
  document.getElementById('copyBtn')?.addEventListener('click', function() {
    const copyText = this.previousElementSibling;
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value);
    this.innerHTML = '<i class="fas fa-check"></i> Copied!';
    setTimeout(() => {
      this.innerHTML = '<i class="fas fa-copy"></i> Copy';
    }, 2000);
  });
</script>

<%- include("../../views/partials/user/footer") %>